<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <style>
        html,
        body {
            font-size: 10px;
            padding: 0;
            margin: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wrap {
            width: 1280px;
            height: 800px;
            display: grid;
            grid-template-columns: 3fr 2fr 5fr;
            grid-template-rows: 1fr 1fr 2fr 2fr;
            gap: 1rem;
            border: 1px solid #eeeeee;
            overflow: hidden;
        }

        .wrap>* {
            border: 1px solid #bbbbbb;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        .wrap>div:nth-child(1) {
            grid-column-start: 1;
            grid-column-end: 2;
            grid-row-start: 1;
            grid-row-end: 5;
        }

        .wrap>div:nth-child(6) {
            grid-column-start: 3;
            grid-column-end: 4;
            grid-row-start: 1;
            grid-row-end: 5;
        }

        .hidden_chk {
            display: none;
        }

        .hidden_chk:checked+label {
            background-color: #f3dcdc
        }

        .list_item {
            display: grid;
            border: 1px solid #aaaadd;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        }

        .list_item:hover {
            background-color: #e8e8fc
        }

        .list_item>div {
            text-align: center;
        }

        .list_item>div:nth-child(6) {
            grid-column-start: 1;
            grid-column-end: 6;
        }



        .app_line,
        .app_files,
        .app_data,
        .app_forms {
            font-size: 16px;
        }


        .detailContentDiv {
            margin-left: 1em;
            margin-right: 1em;
            display: grid;
            grid-template-columns: 20% 20% 20% 10% 10% 10% 10%;
        }



        .detailcontentlast {
            border-left: 1px solid black;
            border-right: 1px solid black;
            border-bottom: 1px solid black;
        }
    </style>
</head>

<body onload="init()">
    <div class="wrap">
        <div class="app_list"></div>
        <div class="app_files"></div>
        <div class="app_line"></div>
        <div class="app_data"></div>
        <div class="app_forms"></div>
        <div class="app_preview"></div>
    </div>
    <script src="js/jquery.min.js"></script>
    <script src="js/cipher.js"></script>
    <script>
        let docList, docInfo, _server = "/system/doc", apiServer = "", storage = {}, cipher;

        cipher = { // 암호화 모듈
            "encRsa": (message) => {
                let result, rsa;
                if (message === undefined || message === null) return message;
                rsa = new RSAKey();
                rsa.setPublic(cipher.rsa.public.modulus, cipher.rsa.public.exponent);
                return btoa(rsa.encrypt(message));
            },
            "encAes": (message) => {
                let cp, result;
                cp = CryptoJS.AES.encrypt(message, CryptoJS.enc.Utf8.parse(cipher.aes.key), {
                    "iv": CryptoJS.enc.Utf8.parse(cipher.aes.iv),
                    "padding": CryptoJS.pad.Pkcs7,
                    "mode": CryptoJS.mode.CBC
                });
                result = cp.toString();
                return result;
            },
            "decAes": (message) => {
                let cp, result;
                cp = CryptoJS.AES.decrypt(message, CryptoJS.enc.Utf8.parse(cipher.aes.key), {
                    iv: CryptoJS.enc.Utf8.parse(cipher.aes.iv),
                    padding: CryptoJS.pad.Pkcs7,
                    mode: CryptoJS.mode.CBC
                });
                result = cp.toString(CryptoJS.enc.Utf8);
                return result;
            },
            "rsa": {
                "public": {
                    "modulus": undefined,
                    "exponent": undefined
                },
                "private": undefined,
                "getKey": () => {
                    let url = apiServer + "/api/user/rsa";
                    $.ajax({
                        url: url,
                        method: "get",
                        dataType: "json",
                        cache: false,
                        success: (data) => {
                            let publicKeyExponent, publicKeyModulus, aesKey, aesIv, url = apiServer + "/api/user/aes";
                            if (data.result === "ok") {
                                aesKey = [cipher.genKey(8), cipher.genKey(8), cipher.genKey(8), cipher.genKey(8)];
                                aesIv = [cipher.genKey(8), cipher.genKey(8)];
                                cipher.aes.key = aesKey[0] + aesKey[1] + aesKey[2] + aesKey[3];
                                cipher.aes.iv = aesIv[0] + aesIv[1];
                                publicKeyExponent = data.data.publicKeyExponent;
                                publicKeyModulus = data.data.publicKeyModulus;
                                cipher.rsa.public.modulus = publicKeyModulus;
                                cipher.rsa.public.exponent = publicKeyExponent;
                                sessionStorage.setItem("rsaModulus", publicKeyModulus);
                                sessionStorage.setItem("rsaExponent", publicKeyExponent);
                                sessionStorage.setItem("aesKey", cipher.aes.key);
                                sessionStorage.setItem("aesIv", cipher.aes.iv);
                                $.ajax({
                                    "url": url,
                                    "method": "post",
                                    data: cipher.encRsa(aesKey[0]) + "\n" + cipher.encRsa(aesKey[1]) + "\n" + cipher.encRsa(aesKey[2]) + "\n" + cipher.encRsa(aesKey[3]) + "\n" + cipher.encRsa(aesIv[0]) + "\n" + cipher.encRsa(aesIv[1]),
                                    contentType: "text/plain",
                                    "cache": false,
                                    success: (data) => {
                                    }
                                })
                            } else {
                                //  msg.set(data.msg);
                            }
                        }
                    })
                }
            },
            "aes": {
                "iv": undefined,
                "key": undefined
            },
            "genKey": (length) => {
                let x, t, result = "", src = [];
                if (isNaN(length) || length < 8) length = 32;
                for (x = 0; x < 69; x++) {
                    if (x < 10)
                        src[x] = (x + 48);
                    else if (x < 36)
                        src[x] = (x + 55);
                    else if (x < 62)
                        src[x] = (x + 61);
                    else if (x == 63)
                        src[x] = 33;
                    else if (x == 64)
                        src[x] = 43;
                    else if (x == 65)
                        src[x] = 126;
                    else
                        src[x] = (x - 31);
                }
                for (x = 0; x < length; x++) {
                    t = Math.floor((Math.random() * src.length));
                    result += String.fromCharCode(src[t])
                }
                return result;
            } // End of getKey()
        }







        function getForms() {
            let url;

            url = apiServer + "/api/gw/form";

            $.ajax({
                "url": url,
                "method": "get",
                "dataType": "json",
                "cache": false,
                success: (data) => {
                    let list;
                    if (data.result === "ok") {
                        list = cipher.decAes(data.data);
                        list = JSON.parse(list);
                        storage.form = list;
                        console.log("[getForms] Success getting employee information.");
                    } else {
                        //  msg.set("양식 정보를 가져오지 못했습니다.");
                    }
                }
            })
        } // End of getUserMap()









        // API 서버에서 직원 정보를 가져오는 함수
        function getUserMap() {
            let url;

            url = apiServer + "/api/user/map";

            $.ajax({
                "url": url,
                "method": "get",
                "dataType": "json",
                "cache": false,
                success: (data) => {
                    let list;

                    if (data.result === "ok") {
                        list = cipher.decAes(data.data);
                        list = JSON.parse(list);
                        storage.user = list;
                        console.log("[getUserMap] Success getting employee information.");
                    } else {
                        //  msg.set("직원 정보를 가져오지 못했습니다.");
                    }
                }
            })
        } // End of getUserMap()

        // API 서버에서 직원 정보를 가져오는 함수
        function getDeptMap() {
            let url;

            url = apiServer + "/api/dept/map";

            $.ajax({
                "url": url,
                "method": "get",
                "dataType": "json",
                "cache": false,
                success: (data) => {
                    let list;

                    if (data.result === "ok") {
                        list = cipher.decAes(data.data);
                        list = JSON.parse(list);
                        storage.dept = list;
                        console.log("[getDeptMap] Success getting department information.");
                    } else {
                        //  msg.set("부서 정보를 가져오지 못했습니다.");
                    }
                }
            })
        } // End of getDeptMap()

        // API 서버에서 고객사 정보를 가져오는 함수
        function getCustomer() {
            let url;

            url = apiServer + "/api/system/customer";

            $.ajax({
                "url": url,
                "method": "get",
                "dataType": "json",
                "cache": false,
                success: (data) => {
                    let list;

                    if (data.result === "ok") {
                        list = cipher.decAes(data.data);
                        list = JSON.parse(list);
                        storage.customer = list;
                        console.log("[getCustomer] Success getting customer information.");
                    } else {
                        // msg.set("고객 정보를 가져오지 못했습니다.");
                    }
                }
            })
        } // End of getCustomer()

        // 초기화 함수
        function init() {
            getList();
            cipher.rsa.getKey()
            window.setTimeout(() => {
                getCustomer();
                getDeptMap();
                getUserMap();
                getForms();
            }, 1000);
            storage.appStatus = { "1": "임시저장", "2": "검토요청", "3": "반려", "4": "검토완료", "5": "완료" }
            storage.status = { "1": "작성중", "2": "진행중", "3": "완료" }
        } // End of init()
        function lineUp(str) { let x, r = 0; for (x in str) r += str[x].charCodeAt(); return r; }
        // 서버에서 문서 목록을 가져오는 함수
        function getList() {
            $.ajax({
                url: _server,
                method: "get",
                success: (result) => {
                    let tt = result.replace(/\n+/g, "");
                    tt = tt.replace(/\t+/g, "");
                    tt = JSON.parse(tt);
                    if (tt.result === "ok") {
                        docList = tt.data;
                        storage.docList = docList;
                        drawDocList();
                    } else {
                        console.log("[ERROR] Failure parse.");
                    }
                },
                error: () => {
                    console.log("[ERROR] Failure getting document information.");
                }
            });
        } // End of getList()

        // 개별 문서 정보를 가져오는 함수
        function getDocData(docNo) {
            $.ajax({
                url: _server + "/" + docNo,
                method: "get",
                success: (result) => {
                    let tt = result.replace(/\n+/g, "");
                    tt = tt.replace(/\t+/g, "");
                    tt = JSON.parse(tt);
                    if (tt.result === "ok") {
                        docInfo = { "files": tt.files, "appData": tt.appData, "docData": tt.docData };
                        storage.docInfo = docInfo;
                        drawClickedDetail(docInfo, docNo);
                    } else {
                        console.log("[ERROR] Failure parse.");
                    }
                },
                error: () => {
                    console.log("[ERROR] Failure getting document information.");
                }
            });
        } // End of getDocData()

        //문서 목록을 화면에 그리는 함수
        function drawDocList() {
            let html, x, doc, cnt;
            if (storage.customer == undefined || storage.user == undefined || storage.dept == undefined) {
                window.setTimeout(drawDocList, 100);
                return;
            }
            cnt = document.getElementsByClassName("app_list")[0];
            html = "";
            for (x in docList) {
                doc = docList[x];
                html += ("<input type=\"checkbox\" id=\"chk" + doc.no + "\" class=\"hidden_chk\" />");
                html += ("<label class=\"list_item\" for=\"chk" + doc.no + "\" data-no=\"" + doc.no + "\" onclick=\"clickedItem(this)\">");
                html += ("<div>" + doc.no + "</div>")
                html += ("<div>" + (new Date(doc.created)).toLocaleString().substring(2, 13).replaceAll(" ", "") + "</div>")
                html += ("<div>" + (storage.customer[doc.customer] != null ? storage.customer[doc.customer].name : doc.customer) + "</div>")
                html += ("<div>" + doc.form + "</div>")
                html += ("<div>" + doc.type + "</div>")
                html += ("<div>" + doc.title + "</div>")
                html += ("<div>" + (storage.user[doc.writer].userName) + "</div>")
                html += ("<div>" + (doc.status + " : " + storage.status[doc.status]) + "</div>")
                html += "</label>";
            }

            cnt.innerHTML = html;
        } // End of drawDocList()

        // 리스트 아이템이 클릭되면 실행되는 함수
        function clickedItem(el) {
            let docNo;
            docNo = el.dataset.no;
            getDocData(docNo);

        } // End of clickedItem()


        function drawClickedDetail(info, no) {
            let fileTarget = $(".app_files");
            let appTarget = $(".app_line");
            let dataTarget = $(".app_data");
            let files, appData, docData = new Array();
            let filesHtml = "";
            let appDataHtml = "";
            let docDataHtml = "";
            //docInfo = { "files": tt.files, "appData": tt.appData, "docData": tt.docData };



            let dataTitles = ["customer", "price", "product", "quantity", "remark", "subTotal", "tax"];
            let appTitles = ["app", "approved", "comment", "issued", "request", "status", "writer"];



            for (let i = 0; i < info.appData.length; i++) {
                appDataHtml += "<div>" + "app_" + info.appData[i].app + "</div>";
                appDataHtml += "<div>" + "approved_" + info.appData[i].approved + "</div>";
                appDataHtml += "<div>" + "comment_" + info.appData[i].comment + "</div>";
                appDataHtml += "<div>" + "issued_" + info.appData[i].issued + "</div>";
                appDataHtml += "<div>" + "request_" + info.appData[i].request + "</div>";
                appDataHtml += "<div>" + "status_" + info.appData[i].status + "</div>";
                appDataHtml += "<div>" + "writer_" + info.appData[i].writer + "</div>";
            }

            appTarget.html(appDataHtml);


            filesHtml += "<div>" + "filename_" + files + "</div>";


            fileTarget.html(filesHtml);
            console.log(info.docData);
            for (let i = 0; i < info.docData.length; i++) {
                docDataHtml += "<div>" + i + "데이터 -------------"
                for (let j = 0; j < dataTitles.length; j++) {

                    docDataHtml += "<div>" + info.docData[i][dataTitles[j]] + "</div>";
                }
            }

            docDataHtml += "</div>"
            dataTarget.html(docDataHtml);


            let target = $(".app_preview");

            let typeHtml = "";


            for (let i = 0; i < info.appData.length; i++) {
                for (let j = 0; j < appTitles.length; j++) {
                    info.appData[i][appTitles[j]];
                }
            }


            for (let i = 0; i < storage.docList.length; i++) {
                if (storage.docList[i].no == no) {
                    if (storage.docList[i].type == "TRS" || storage.docList[i].type == "BUY") {
                        target.html(storage.form[0].form);
                        let id = storage.form[0].id;


                        ////// info title content 출력하기 
                        let docListTitle = Object.keys(storage.docList[i]);
                        for (let k = 0; k < Object.keys(storage.docList[i]).length; k++) {
                            for (let j = 0; j < docListTitle.length; j++) {
                                console.log(docListTitle[j]);
                                $("#" + id + "_" + docListTitle[j]).val(storage.docList[i][docListTitle[j]]);
                            }
                        }


                        // 결재선 출력하기 

                        $("#" + id + "_line").html(
                            "<input type='text' id='" + id + "_app'>" +
                            "<input type='text' id='" + id + "_approved'>" +
                            "<input type='text' id='" + id + "_comment'>" +
                            "<input type='text' id='" + id + "_status'>");

                        for (let i = 0; i < info.appData.length; i++) {
                            for (let j = 0; j < appTitles.length; j++) {

                                if (info.appData[i][appTitles[j]] != null) {
                                    $("#" + id + "_" + appTitles[j]).val(info.appData[i][appTitles[j]]);
                                }
                            }
                        }




                        // 상세데이터 출력 

                        let dataHtml = ""
                        alert(Object.keys(info.docData).length);

                        for (let q = 0; q < Object.keys(info.docData).length; q++) {
                            dataHtml += "<div class='detailContentDiv'>"
                            for (let j = 0; j < dataTitles.length; j++) {
                                if (j == (dataTitles.length - 1)) {
                                    dataHtml += "<div id='child' class='countRow detailcontentlast'><input class='inputs' type='text' value='" + info.docData[q][dataTitles[j]] + "' id='" + id + "_" + dataTitles[j] + q + "'></div>";
                                } else {
                                    dataHtml += "<div id='child' class='countRow detailcontent'><input class='inputs' type='text' value='" + info.docData[q][dataTitles[j]] + "' id='" + id + "_" + dataTitles[j] + q + "'></div>";
                                }

                            } dataHtml += "</div>"
                        }




                        $(".insertedDataList").html(dataHtml);





                    } else if (storage.docList[i].type == "COST" || storage.docList[i].type == "CREDIT" ||
                        storage.docList[i].type == "PAY" || storage.docList[i].type == "TAX") {
                        target.html(storage.form[1].form)
                        let id = storage.form[1].id;
                        // doclist data 출력하기 

                        let docListTitle = Object.keys(storage.docList[i]);
                        for (let k = 0; k < Object.keys(storage.docList[i]).length; k++) {
                            for (let j = 0; j < docListTitle.length; j++) {
                                console.log(docListTitle[j]);
                                $("#" + id + "_" + docListTitle[j]).val(storage.docList[i][docListTitle[j]]);
                            }
                        }


                        /// app data 출력하기 

                        $("#" + id + "_line").html(
                            "<input type='text' id='" + id + "_app'>" +
                            "<input type='text' id='" + id + "_approved'>" +
                            "<input type='text' id='" + id + "_comment'>" +
                            "<input type='text' id='" + id + "_status'>");

                        for (let i = 0; i < info.appData.length; i++) {
                            for (let j = 0; j < appTitles.length; j++) {

                                if (info.appData[i][appTitles[j]] != null) {
                                    $("#" + id + "_" + appTitles[j]).val(info.appData[i][appTitles[j]]);
                                }
                            }
                        }








                    } else if (storage.docList[i].type == "PUR") {
                        target.html(storage.form[2].form)
                        let id = storage.form[2].id;
                        // doclist data 출력하기 

                        let docListTitle = Object.keys(storage.docList[i]);
                        for (let k = 0; k < Object.keys(storage.docList[i]).length; k++) {
                            for (let j = 0; j < docListTitle.length; j++) {

                                $("#" + id + "_" + docListTitle[j]).val(storage.docList[i][docListTitle[j]]);
                            }
                        }


                        /// app data 출력하기 

                        $("#" + id + "_line").html(
                            "<input type='text' id='" + id + "_app'>" +
                            "<input type='text' id='" + id + "_approved'>" +
                            "<input type='text' id='" + id + "_comment'>" +
                            "<input type='text' id='" + id + "_request'>" +
                            "<input type='text' id='" + id + "_status'>");

                        for (let i = 0; i < info.appData.length; i++) {
                            for (let j = 0; j < appTitles.length; j++) {

                                if (info.appData[i][appTitles[j]] != null) {
                                    $("#" + id + "_" + appTitles[j]).val(info.appData[i][appTitles[j]]);
                                }
                            }
                        }






                    } else if (storage.docList[i].type == "DIP") {
                        target.html(storage.form[3].form)
                        let id = storage.form[3].id;
                        // doclist data 출력하기 

                        let docListTitle = Object.keys(storage.docList[i]);
                        for (let k = 0; k < Object.keys(storage.docList[i]).length; k++) {
                            for (let j = 0; j < docListTitle.length; j++) {
                                $("#" + id + "_" + docListTitle[j]).val(storage.docList[i][docListTitle[j]]);
                            }
                        }


                        /// app data 출력하기 

                        $("#" + id + "_line").html(
                            "<input type='text' id='" + id + "_app'>" +
                            "<input type='text' id='" + id + "_approved'>" +
                            "<input type='text' id='" + id + "_comment'>" +
                            "<input type='text' id='" + id + "_status'>");

                        for (let i = 0; i < info.appData.length; i++) {
                            for (let j = 0; j < appTitles.length; j++) {

                                if (info.appData[i][appTitles[j]] != null) {
                                    $("#" + id + "_" + appTitles[j]).val(info.appData[i][appTitles[j]]);
                                }
                            }
                        }







                    }


                }

            }



        }

            // for (let i = 0; i < storage.form.length; i++) {
            //     typeHtml += "<button type='button' value='" + i + "' onclick='drawForm(this.value)'>" + storage.form[i].id + "</button>"
            // }

            // typeFormList.html(typeHtml);








    </script>
</body>

</html>